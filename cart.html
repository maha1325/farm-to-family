<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart - Farm to Family</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="logo">üåæ Farm To Family</h1>
            <ul class="nav-menu">
                <li><a href="buyer-home.html">Home</a></li>
                <li><a href="cart.html" class="active">Cart</a></li>
                <li><a href="#" id="logoutBtn">Logout</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="cart-header">
            <h1>Shopping Cart</h1>
            <button class="btn btn-secondary" onclick="window.location.href='buyer-home.html'">‚Üê Continue Shopping</button>
        </div>

        <div id="cartContent">
            <div id="cartItems"></div>
            <div class="cart-summary">
                <h2>Cart Summary</h2>
                <div class="summary-row">
                    <span>Total Items:</span>
                    <span id="totalItems">0</span>
                </div>
                <div class="summary-row total">
                    <span>Total Price:</span>
                    <span id="totalPrice">$0.00</span>
                </div>
                <button class="btn btn-primary btn-block" id="checkoutBtn">Proceed to Checkout</button>
                <button class="btn btn-danger btn-block" id="clearCartBtn">Clear Cart</button>
            </div>
        </div>

        <div id="emptyCart" style="display: none;">
            <div class="empty-state">
                <h2>Your cart is empty</h2>
                <p>Start shopping to add items to your cart</p>
                <button class="btn btn-primary" onclick="window.location.href='buyer-home.html'">Start Shopping</button>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/buyer.js"></script>
    <script>
        async function loadCart() {
            try {
                const cart = await apiCall('/api/cart', 'GET');
                
                if (!cart.items || cart.items.length === 0) {
                    document.getElementById('cartContent').style.display = 'none';
                    document.getElementById('emptyCart').style.display = 'block';
                    return;
                }

                let totalItems = 0;
                let totalPrice = 0;
                let cartHTML = '<div class="cart-items-list">';

                cart.items.forEach(item => {
                    const product = item.productId;
                    const itemTotal = item.price * item.quantity;
                    totalItems += item.quantity;
                    totalPrice += itemTotal;

                    cartHTML += `
                        <div class="cart-item">
                            <img src="${API_BASE_URL}${product.image}" alt="${product.name}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22>No Image</text></svg>'">
                            <div class="cart-item-details">
                                <h3>${product.name}</h3>
                                <p>Price: ‚Çπ${item.price} / ${product.unit}</p>
<p>Subtotal: ‚Çπ${itemTotal.toFixed(2)}</p>
                            </div>
                            <div class="cart-item-actions">
                                <div class="quantity-controls">
                                    <button class="btn-quantity" onclick="updateQuantity('${product._id}', ${item.quantity - 1})">-</button>
                                    <span class="quantity">${item.quantity}</span>
                                    <button class="btn-quantity" onclick="updateQuantity('${product._id}', ${item.quantity + 1})">+</button>
                                </div>
                                <button class="btn btn-danger btn-sm" onclick="removeFromCart('${product._id}')">Remove</button>
                            </div>
                        </div>
                    `;
                });

                cartHTML += '</div>';
                document.getElementById('cartItems').innerHTML = cartHTML;
                document.getElementById('totalItems').textContent = totalItems;
                document.getElementById('totalPrice').textContent = '‚Çπ' + totalPrice.toFixed(2);
                document.getElementById('cartContent').style.display = 'block';
                document.getElementById('emptyCart').style.display = 'none';
            } catch (error) {
                console.error('Error loading cart:', error);
            }
        }

        async function updateQuantity(productId, quantity) {
            if (quantity < 1) {
                if (!confirm('Remove this item from cart?')) return;
                await removeFromCart(productId);
                return;
            }

            try {
                await apiCall('/api/cart/update', 'PUT', { productId, quantity });
                loadCart();
            } catch (error) {
                alert('Error updating cart: ' + error.message);
            }
        }

        async function removeFromCart(productId) {
            try {
                await apiCall(`/api/cart/remove/${productId}`, 'DELETE');
                loadCart();
            } catch (error) {
                alert('Error removing item: ' + error.message);
            }
        }

        document.getElementById('checkoutBtn').addEventListener('click', () => {
            window.location.href = 'checkout.html';
        });

        document.getElementById('clearCartBtn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to clear your cart?')) return;
            
            try {
                await apiCall('/api/cart/clear', 'DELETE');
                loadCart();
            } catch (error) {
                alert('Error clearing cart: ' + error.message);
            }
        });

        loadCart();
    </script>
</body>
</html>